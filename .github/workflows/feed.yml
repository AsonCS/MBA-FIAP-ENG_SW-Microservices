name: Feed Service CI/CD

on:
  push:
    branches:
      - main
      - develop
      - ai
    paths:
      - 'feed/**'
      - '.github/workflows/feed.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'feed/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/feed

jobs:
  # Stage 1: Test
  test:
    name: Test Feed Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Run unit tests
        working-directory: feed
        run: ./gradlew test --no-daemon -i

      - name: Generate test report
        if: always()
        working-directory: feed
        run: ./gradlew jacocoTestReport || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: feed-test-results
          path: feed/build/reports/tests/test/
          retention-days: 30

      - name: Publish test report
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: feed/build/test-results/**/*.xml
          check_name: Feed Service Test Results
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./feed/build/reports/jacoco/test/jacocoTestReport.xml
          flags: feed
          name: feed-coverage
        continue-on-error: true

  # Stage 2: Build
  build:
    name: Build JAR & Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Build JAR
        working-directory: feed
        run: ./gradlew build -x test --no-daemon

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: feed-jar
          path: feed/build/libs/feed-*.jar
          retention-days: 7

      - name: Generate Docker image metadata
        id: meta
        run: |
          DOCKER_IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/feed"
          DOCKER_TAGS=""
          VERSION="dev"
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION="prod-${{ github.sha }}"
            DOCKER_TAGS="${DOCKER_IMAGE}:${VERSION},${{ env.REGISTRY }}/${{ github.repository_owner }}/feed:latest"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            VERSION="dev-${{ github.sha }}"
            DOCKER_TAGS="${DOCKER_IMAGE}:${VERSION},${{ env.REGISTRY }}/${{ github.repository_owner }}/feed:develop"
          else
            VERSION="ci-${{ github.sha }}"
            DOCKER_TAGS="${DOCKER_IMAGE}:${VERSION}"
          fi
          
          echo "tags=${DOCKER_TAGS}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "image=${DOCKER_IMAGE}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./feed
          file: ./feed/Dockerfile
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: Generate build info
        run: |
          mkdir -p feed/build-info
          cat > feed/build-info/metadata.txt << EOF
          VERSION=${{ steps.meta.outputs.version }}
          COMMIT_SHA=${{ github.sha }}
          BRANCH=${{ github.ref_name }}
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          BUILD_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          IMAGE_TAG=${{ steps.meta.outputs.tags }}
          EOF
          cat feed/build-info/metadata.txt

      - name: Upload build metadata
        uses: actions/upload-artifact@v4
        with:
          name: feed-build-metadata
          path: feed/build-info/
          retention-days: 30

  # Stage 3: Quality Gate
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Run Kotlin linter (Detekt)
        working-directory: feed
        run: ./gradlew detekt || true
        continue-on-error: true

      - name: Upload Detekt report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-report
          path: feed/build/reports/detekt/
        continue-on-error: true

      - name: SonarQube analysis
        working-directory: feed
        run: ./gradlew sonarqube || true
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_LOGIN: ${{ secrets.SONAR_LOGIN }}
        continue-on-error: true

  # Stage 4: Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'feed/'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
        continue-on-error: true

      - name: Run Trivy vulnerability scanner (image)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/feed:${{ needs.build.outputs.version }}
          format: 'sarif'
          output: 'trivy-image-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-*.sarif'
        continue-on-error: true

  # Stage 5: Integration Test
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    
    services:
      kafka:
        image: confluentinc/cp-kafka:latest
        env:
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
          KAFKA_BROKER_ID: 1
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
        options: >-
          --health-cmd "kafka-broker-api-versions.sh --bootstrap-server localhost:9092"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Test Docker image
        run: |
          docker run -d \
            --name feed-test \
            -p 8080:8080 \
            -e KAFKA_BROKER=kafka:9092 \
            --network host \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/feed:${{ needs.build.outputs.version }}
          
          echo "Waiting for service to start..."
          sleep 10
          
          echo "Testing health endpoint..."
          curl -f http://localhost:8080/health || exit 1
          
          echo "Testing API endpoints..."
          curl -f http://localhost:8080/api/subjects || exit 1
          curl -f http://localhost:8080/api/docs || exit 1
          
          echo "Checking logs..."
          docker logs feed-test
          
          docker stop feed-test
        continue-on-error: true

  # Stage 6: Notification
  notify:
    name: Notify on Completion
    runs-on: ubuntu-latest
    needs: [ test, build, quality, security ]
    if: always()
    
    steps:
      - name: Determine job status
        id: status
        run: |
          if [ "${{ needs.test.result }}" = "failure" ] || [ "${{ needs.build.result }}" = "failure" ]; then
            echo "overall_status=❌ FAILED" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "overall_status=✅ SUCCESS" >> $GITHUB_OUTPUT
          fi

      - name: Create job summary
        run: |
          echo "# Feed Service CI/CD Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status: ${{ steps.status.outputs.overall_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Details:** [${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification (success)
        if: steps.status.outputs.overall_status == '✅ SUCCESS'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            Feed Service CI/CD completed successfully
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

      - name: Send Slack notification (failure)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            Feed Service CI/CD failed
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

